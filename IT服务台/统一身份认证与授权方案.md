# 统一身份认证与授权方案

## 一、方案总览

### 1.1 架构设计

```
┌────────────────────────────────────────────────────────────────────────┐
│                           前端应用层                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │  产品前端     │  │  IT服务台前端 │  │  AI平台前端  │                │
│  │  (Product)   │  │  (Service Desk)│  │  (AI Portal) │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│         │                 │                 │                          │
│         └─────────────────┼─────────────────┘                          │
│                           ↓                                            │
│              统一登录页 (SSO Login Page)                                │
└────────────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────────────┐
│                    统一API网关 (API Gateway)                            │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │  • 统一鉴权拦截                                                 │     │
│  │  • JWT Token验证                                               │     │
│  │  • 权限校验（RBAC）                                             │     │
│  │  • 请求路由                                                     │     │
│  └──────────────────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────────────┐
│                  统一认证中心 (Auth Service)                            │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │  核心功能：                                                     │     │
│  │  • 用户登录/登出                                                │     │
│  │  • Token生成与验证                                              │     │
│  │  • 用户信息管理                                                 │     │
│  │  • 权限管理（RBAC）                                             │     │
│  │  • SSO（单点登录）                                              │     │
│  │  • Session管理                                                 │     │
│  └──────────────────────────────────────────────────────────────┘     │
│                                                                        │
│  数据存储：                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │  MySQL      │  │  Redis      │  │  LDAP/AD    │                  │
│  │  用户、角色  │  │  Token缓存  │  │  企业目录    │                  │
│  │  权限数据    │  │  Session    │  │  (可选)     │                  │
│  └─────────────┘  └─────────────┘  └─────────────┘                  │
└────────────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────────────┐
│                       后端服务层                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │  产品服务     │  │  IT服务台服务 │  │  AI能力平台   │                │
│  │  (Product)   │  │  (Service Desk)│  │  (AI Platform)│                │
│  │              │  │  • 工单服务   │  │  • LLM服务    │                │
│  │              │  │  • 用户服务   │  │  • RAG引擎    │                │
│  │              │  │  • 通知服务   │  │  • 知识库服务  │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│         ↑                 ↑                 ↑                          │
│         └─────────────────┼─────────────────┘                          │
│                           │                                            │
│              Token验证（验证JWT签名和有效期）                            │
└────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| **统一入口** | 所有模块共用一个统一认证中心 (Auth Service) |
| **无状态鉴权** | 使用JWT Token，避免服务端Session依赖 |
| **单点登录** | 一次登录，三个平台通用（SSO） |
| **安全性** | Token加密、HTTPS传输、防重放攻击 |
| **可扩展** | 支持接入更多模块、支持多租户 |

---

## 二、认证流程设计

### 2.1 首次登录流程

```
┌──────┐                                                    ┌──────────┐
│ 用户  │                                                    │认证中心  │
└──────┘                                                    └──────────┘
    │                                                              │
    │ 1. 访问 IT服务台前端                                         │
    ├────────────────────────────────────────────────────────────▶│
    │                                                              │
    │ 2. 检测未登录，重定向到统一登录页                             │
    │◀────────────────────────────────────────────────────────────┤
    │    /login?redirect=https://servicedesk.com/home              │
    │                                                              │
    │ 3. 输入用户名、密码                                          │
    ├────────────────────────────────────────────────────────────▶│
    │    POST /api/auth/login                                      │
    │    { username, password }                                    │
    │                                                              │
    │                              ┌──────────────────────────┐   │
    │                              │ 4. 验证用户名密码         │   │
    │                              │    - 查询数据库          │   │
    │                              │    - 密码哈希比对        │   │
    │                              │    - 查询用户角色权限     │   │
    │                              └──────────────────────────┘   │
    │                                                              │
    │ 5. 返回JWT Token                                             │
    │◀────────────────────────────────────────────────────────────┤
    │    {                                                         │
    │      access_token: "eyJhbGc...",  (30分钟有效)               │
    │      refresh_token: "eyJhbGc...", (7天有效)                  │
    │      user: {...},                                            │
    │      permissions: [...]                                      │
    │    }                                                         │
    │                                                              │
    │ 6. 存储Token到localStorage                                   │
    │    重定向到原页面                                             │
    ├──────────────────▶                                           │
    │                                                              │
    │ 7. 携带Token访问业务API                                       │
    ├────────────────────────────────────────────────────────────▶│
    │    GET /api/tickets                                          │
    │    Authorization: Bearer eyJhbGc...                          │
    │                                                              │
    │                              ┌──────────────────────────┐   │
    │                              │ 8. 验证Token              │   │
    │                              │    - 验证签名            │   │
    │                              │    - 验证有效期          │   │
    │                              │    - 解析用户信息        │   │
    │                              │    - 检查权限            │   │
    │                              └──────────────────────────┘   │
    │                                                              │
    │ 9. 返回业务数据                                               │
    │◀────────────────────────────────────────────────────────────┤
    │                                                              │
```

### 2.2 跨平台访问流程（SSO）

```
场景：用户已登录"产品"，现在访问"IT服务台"

┌──────┐                                                    ┌──────────┐
│ 用户  │                                                    │认证中心  │
└──────┘                                                    └──────────┘
    │                                                              │
    │ 1. 已登录"产品"，Token存储在localStorage                      │
    │                                                              │
    │ 2. 点击导航，跳转到"IT服务台"                                 │
    ├──────────────────▶                                           │
    │    访问：https://servicedesk.com                             │
    │                                                              │
    │ 3. IT服务台前端检测localStorage中的Token                      │
    │                                                              │
    │ 4. 携带Token请求验证                                          │
    ├────────────────────────────────────────────────────────────▶│
    │    POST /api/auth/verify                                     │
    │    Authorization: Bearer eyJhbGc...                          │
    │                                                              │
    │                              ┌──────────────────────────┐   │
    │                              │ 5. 验证Token有效性        │   │
    │                              │    - 验证签名            │   │
    │                              │    - 验证有效期          │   │
    │                              └──────────────────────────┘   │
    │                                                              │
    │ 6. Token有效，返回用户信息                                    │
    │◀────────────────────────────────────────────────────────────┤
    │    { valid: true, user: {...}, permissions: [...] }         │
    │                                                              │
    │ 7. 直接登录成功，无需重新输入密码 ✅                           │
    │    这就是SSO（单点登录）效果                                  │
    │                                                              │
```

**关键点：**
- Token存储在浏览器localStorage，跨域名共享（需同一顶级域名）
- 或使用Cookie（设置domain为顶级域名，如`.company.com`）
- 三个平台共享同一个Token，实现真正的SSO

### 2.3 Token刷新流程

```
┌──────┐                                                    ┌──────────┐
│ 用户  │                                                    │认证中心  │
└──────┘                                                    └──────────┘
    │                                                              │
    │ 1. 访问业务API                                               │
    ├────────────────────────────────────────────────────────────▶│
    │    GET /api/tickets                                          │
    │    Authorization: Bearer eyJhbGc...                          │
    │                                                              │
    │                              ┌──────────────────────────┐   │
    │                              │ 2. 验证Token              │   │
    │                              │    发现Token已过期        │   │
    │                              └──────────────────────────┘   │
    │                                                              │
    │ 3. 返回401 Token已过期                                        │
    │◀────────────────────────────────────────────────────────────┤
    │    { code: 401, message: "Token expired" }                  │
    │                                                              │
    │ 4. 前端拦截器捕获401，自动调用刷新接口                         │
    ├────────────────────────────────────────────────────────────▶│
    │    POST /api/auth/refresh                                    │
    │    { refresh_token: "eyJhbGc..." }                           │
    │                                                              │
    │                              ┌──────────────────────────┐   │
    │                              │ 5. 验证refresh_token      │   │
    │                              │    生成新的access_token   │   │
    │                              └──────────────────────────┘   │
    │                                                              │
    │ 6. 返回新Token                                                │
    │◀────────────────────────────────────────────────────────────┤
    │    { access_token: "eyJhbGc...", refresh_token: "..." }     │
    │                                                              │
    │ 7. 更新localStorage，重试原请求                               │
    ├────────────────────────────────────────────────────────────▶│
    │    GET /api/tickets (重试)                                   │
    │    Authorization: Bearer [新Token]                           │
    │                                                              │
    │ 8. 返回数据                                                   │
    │◀────────────────────────────────────────────────────────────┤
    │                                                              │
```

**Token有效期设计：**
- `access_token`: 30分钟（短期，用于API访问）
- `refresh_token`: 7天（长期，用于刷新access_token）
- 用户无感刷新，体验流畅

---

---

## 三、跨平台SSO实现

### 3.1 Cookie共享方案（推荐）

```typescript
// 场景：三个平台共享顶级域名
// - product.company.com
// - servicedesk.company.com
// - ai.company.com

// 登录成功后，设置Cookie到顶级域名
function setAuthCookie(accessToken: string, refreshToken: string) {
  // 设置Cookie到 .company.com（注意前面的点）
  document.cookie = `access_token=${accessToken}; domain=.company.com; path=/; secure; samesite=strict; max-age=1800`;
  document.cookie = `refresh_token=${refreshToken}; domain=.company.com; path=/; secure; samesite=strict; max-age=604800`;
}

// 其他子域名自动共享此Cookie
// servicedesk.company.com 访问时会自动携带 access_token
```

**优点：**
- 真正的无感SSO
- 自动携带Cookie，无需手动处理
- 安全性高（HttpOnly, Secure, SameSite）

**限制：**
- 必须是同一顶级域名

### 3.2 LocalStorage + iframe通信方案

```typescript
// 适用于不同域名的跨域SSO
// - product.com
// - servicedesk.com
// - ai-platform.com

// ========== 认证中心（auth.company.com）==========
// auth.company.com/sso-bridge.html
window.addEventListener('message', (event) => {
  if (event.data.action === 'getToken') {
    const accessToken = localStorage.getItem('access_token');
    const refreshToken = localStorage.getItem('refresh_token');

    event.source.postMessage({
      action: 'tokenResponse',
      accessToken,
      refreshToken,
    }, event.origin);
  }

  if (event.data.action === 'setToken') {
    localStorage.setItem('access_token', event.data.accessToken);
    localStorage.setItem('refresh_token', event.data.refreshToken);

    event.source.postMessage({
      action: 'tokenSet',
      success: true,
    }, event.origin);
  }
});

// ========== 业务平台（servicedesk.com）==========
// 通过iframe获取Token
function getTokenFromAuthCenter(): Promise<{ accessToken: string; refreshToken: string }> {
  return new Promise((resolve, reject) => {
    // 创建隐藏iframe
    const iframe = document.createElement('iframe');
    iframe.src = 'https://auth.company.com/sso-bridge.html';
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    // 监听消息
    const messageHandler = (event: MessageEvent) => {
      if (event.origin !== 'https://auth.company.com') return;

      if (event.data.action === 'tokenResponse') {
        window.removeEventListener('message', messageHandler);
        document.body.removeChild(iframe);

        if (event.data.accessToken) {
          resolve({
            accessToken: event.data.accessToken,
            refreshToken: event.data.refreshToken,
          });
        } else {
          reject(new Error('No token found'));
        }
      }
    };

    window.addEventListener('message', messageHandler);

    // iframe加载完成后发送消息
    iframe.onload = () => {
      iframe.contentWindow?.postMessage({ action: 'getToken' }, 'https://auth.company.com');
    };

    // 超时处理
    setTimeout(() => {
      window.removeEventListener('message', messageHandler);
      document.body.removeChild(iframe);
      reject(new Error('Timeout'));
    }, 5000);
  });
}

// 使用
async function initAuth() {
  try {
    const tokens = await getTokenFromAuthCenter();
    localStorage.setItem('access_token', tokens.accessToken);
    localStorage.setItem('refresh_token', tokens.refreshToken);
    console.log('SSO登录成功');
  } catch (error) {
    console.log('未登录，跳转登录页');
    window.location.href = 'https://auth.company.com/login?redirect=' + window.location.href;
  }
}
```
